(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Validation=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";var hasOwn=Object.prototype.hasOwnProperty;var toStr=Object.prototype.toString;var isArray=function isArray(arr){if(typeof Array.isArray==="function"){return Array.isArray(arr)}return toStr.call(arr)==="[object Array]"};var isPlainObject=function isPlainObject(obj){if(!obj||toStr.call(obj)!=="[object Object]"){return false}var hasOwnConstructor=hasOwn.call(obj,"constructor");var hasIsPrototypeOf=obj.constructor&&obj.constructor.prototype&&hasOwn.call(obj.constructor.prototype,"isPrototypeOf");if(obj.constructor&&!hasOwnConstructor&&!hasIsPrototypeOf){return false}var key;for(key in obj){}return typeof key==="undefined"||hasOwn.call(obj,key)};module.exports=function extend(){var options,name,src,copy,copyIsArray,clone;var target=arguments[0];var i=1;var length=arguments.length;var deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(target==null||typeof target!=="object"&&typeof target!=="function"){target={}}for(;i<length;++i){options=arguments[i];if(options!=null){for(name in options){src=target[name];copy=options[name];if(target!==copy){if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=extend(deep,clone,copy)}else if(typeof copy!=="undefined"){target[name]=copy}}}}}return target}},{}],2:[function(require,module,exports){"use strict";module.exports=function(header){var result={"content-md5":"Content-MD5",dnt:"DNT",etag:"ETag","last-event-id":"Last-Event-ID",tcn:"TCN",te:"TE","www-authenticate":"WWW-Authenticate","x-dnsprefetch-control":"X-DNSPrefetch-Control"}[header.toLowerCase()];if(result){return result}return header.split("-").map(function(text){return text.charAt(0).toUpperCase()+text.substr(1).toLowerCase()}).join("-")}},{}],3:[function(require,module,exports){var has=Object.prototype.hasOwnProperty;var toString=Object.prototype.toString;function isEmpty(val){if(val==null)return true;if("boolean"==typeof val)return false;if("number"==typeof val)return val===0;if("string"==typeof val)return val.length===0;if("function"==typeof val)return val.length===0;if(Array.isArray(val))return val.length===0;if(val instanceof Error)return val.message==="";if(val.toString==toString){switch(val.toString()){case"[object File]":case"[object Map]":case"[object Set]":{return val.size===0}case"[object Object]":{for(var key in val){if(has.call(val,key))return false}return true}}}return false}module.exports=isEmpty},{}],4:[function(require,module,exports){"use strict";function _interopDefault(ex){return ex&&typeof ex==="object"&&"default"in ex?ex["default"]:ex}var lie=_interopDefault(require("lie"));var PouchPromise=typeof Promise==="function"?Promise:lie;module.exports=PouchPromise},{lie:6}],5:[function(require,module,exports){(function(global){"use strict";var Mutation=global.MutationObserver||global.WebKitMutationObserver;var scheduleDrain;{if(Mutation){var called=0;var observer=new Mutation(nextTick);var element=global.document.createTextNode("");observer.observe(element,{characterData:true});scheduleDrain=function(){element.data=called=++called%2}}else if(!global.setImmediate&&typeof global.MessageChannel!=="undefined"){var channel=new global.MessageChannel;channel.port1.onmessage=nextTick;scheduleDrain=function(){channel.port2.postMessage(0)}}else if("document"in global&&"onreadystatechange"in global.document.createElement("script")){scheduleDrain=function(){var scriptEl=global.document.createElement("script");scriptEl.onreadystatechange=function(){nextTick();scriptEl.onreadystatechange=null;scriptEl.parentNode.removeChild(scriptEl);scriptEl=null};global.document.documentElement.appendChild(scriptEl)}}else{scheduleDrain=function(){setTimeout(nextTick,0)}}}var draining;var queue=[];function nextTick(){draining=true;var i,oldQueue;var len=queue.length;while(len){oldQueue=queue;queue=[];i=-1;while(++i<len){oldQueue[i]()}len=queue.length}draining=false}module.exports=immediate;function immediate(task){if(queue.push(task)===1&&!draining){scheduleDrain()}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],6:[function(require,module,exports){"use strict";var immediate=require("immediate");function INTERNAL(){}var handlers={};var REJECTED=["REJECTED"];var FULFILLED=["FULFILLED"];var PENDING=["PENDING"];module.exports=Promise;function Promise(resolver){if(typeof resolver!=="function"){throw new TypeError("resolver must be a function")}this.state=PENDING;this.queue=[];this.outcome=void 0;if(resolver!==INTERNAL){safelyResolveThenable(this,resolver)}}Promise.prototype["catch"]=function(onRejected){return this.then(null,onRejected)};Promise.prototype.then=function(onFulfilled,onRejected){if(typeof onFulfilled!=="function"&&this.state===FULFILLED||typeof onRejected!=="function"&&this.state===REJECTED){return this}var promise=new this.constructor(INTERNAL);if(this.state!==PENDING){var resolver=this.state===FULFILLED?onFulfilled:onRejected;unwrap(promise,resolver,this.outcome)}else{this.queue.push(new QueueItem(promise,onFulfilled,onRejected))}return promise};function QueueItem(promise,onFulfilled,onRejected){this.promise=promise;if(typeof onFulfilled==="function"){this.onFulfilled=onFulfilled;this.callFulfilled=this.otherCallFulfilled}if(typeof onRejected==="function"){this.onRejected=onRejected;this.callRejected=this.otherCallRejected}}QueueItem.prototype.callFulfilled=function(value){handlers.resolve(this.promise,value)};QueueItem.prototype.otherCallFulfilled=function(value){unwrap(this.promise,this.onFulfilled,value)};QueueItem.prototype.callRejected=function(value){handlers.reject(this.promise,value)};QueueItem.prototype.otherCallRejected=function(value){unwrap(this.promise,this.onRejected,value)};function unwrap(promise,func,value){immediate(function(){var returnValue;try{returnValue=func(value)}catch(e){return handlers.reject(promise,e)}if(returnValue===promise){handlers.reject(promise,new TypeError("Cannot resolve promise with itself"))}else{handlers.resolve(promise,returnValue)}})}handlers.resolve=function(self,value){var result=tryCatch(getThen,value);if(result.status==="error"){return handlers.reject(self,result.value)}var thenable=result.value;if(thenable){safelyResolveThenable(self,thenable)}else{self.state=FULFILLED;self.outcome=value;var i=-1;var len=self.queue.length;while(++i<len){self.queue[i].callFulfilled(value)}}return self};handlers.reject=function(self,error){self.state=REJECTED;self.outcome=error;var i=-1;var len=self.queue.length;while(++i<len){self.queue[i].callRejected(error)}return self};function getThen(obj){var then=obj&&obj.then;if(obj&&(typeof obj==="object"||typeof obj==="function")&&typeof then==="function"){return function appyThen(){then.apply(obj,arguments)}}}function safelyResolveThenable(self,thenable){var called=false;function onError(value){if(called){return}called=true;handlers.reject(self,value)}function onSuccess(value){if(called){return}called=true;handlers.resolve(self,value)}function tryToUnwrap(){thenable(onSuccess,onError)}var result=tryCatch(tryToUnwrap);if(result.status==="error"){onError(result.value)}}function tryCatch(func,value){var out={};try{out.value=func(value);out.status="success"}catch(e){out.status="error";out.value=e}return out}Promise.resolve=resolve;function resolve(value){if(value instanceof this){return value}return handlers.resolve(new this(INTERNAL),value)}Promise.reject=reject;function reject(reason){var promise=new this(INTERNAL);return handlers.reject(promise,reason)}Promise.all=all;function all(iterable){var self=this;if(Object.prototype.toString.call(iterable)!=="[object Array]"){return this.reject(new TypeError("must be an array"))}var len=iterable.length;var called=false;if(!len){return this.resolve([])}var values=new Array(len);var resolved=0;var i=-1;var promise=new this(INTERNAL);while(++i<len){allResolver(iterable[i],i)}return promise;function allResolver(value,i){self.resolve(value).then(resolveFromAll,function(error){if(!called){called=true;handlers.reject(promise,error)}});function resolveFromAll(outValue){values[i]=outValue;if(++resolved===len&&!called){called=true;handlers.resolve(promise,values)}}}}Promise.race=race;function race(iterable){var self=this;if(Object.prototype.toString.call(iterable)!=="[object Array]"){return this.reject(new TypeError("must be an array"))}var len=iterable.length;var called=false;if(!len){return this.resolve([])}var i=-1;var promise=new this(INTERNAL);while(++i<len){resolver(iterable[i])}return promise;function resolver(value){self.resolve(value).then(function(response){if(!called){called=true;handlers.resolve(promise,response)}},function(error){if(!called){called=true;handlers.reject(promise,error)}})}}},{immediate:5}],7:[function(require,module,exports){"use strict";module.exports=function nodify(promise,callback){if(typeof callback==="function"){promise.then(function(resp){callback(null,resp)},function(err){callback(err,null)})}}},{}],8:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],9:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],10:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":8,"./encode":9}],11:[function(require,module,exports){module.exports=function(){var d=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=="x"?r:r&3|8).toString(16)})}},{}],12:[function(require,module,exports){"use strict";var PouchPluginError=require("pouchdb-plugin-error");var extend=require("extend");exports.evaluate=function(requireContext,extraVars,program){var require;if(requireContext){require=function(libPath){var requireLocals=extend({module:{id:libPath,current:undefined,parent:undefined,exports:{}}},locals);requireLocals.exports=requireLocals.module.exports;var path=libPath.split("/");var lib=requireContext;for(var i=0;i<path.length;i+=1){lib=lib[path[i]]}lib+="\nreturn module.exports;";return evalProgram(lib,requireLocals)}}program=program.replace(/;\s*$/,"");var locals=extend({isArray:isArray,toJSON:toJSON,log:log,sum:sum,require:require},extraVars);var func;try{func=evalProgram("return "+program,locals);if(typeof func!=="function"){throw"no function"}}catch(e){throw new PouchPluginError({name:"compilation_error",status:500,message:"Expression does not eval to a function. "+program})}return func};var isArray=Array.isArray;var toJSON=JSON.stringify;var log=function(message){if(typeof message!="string"){message=JSON.stringify(message)}console.log("EVALUATED FUNCTION LOGS: "+message)};var sum=function(array){return array.reduce(function(a,b){return a+b})};function evalProgram(program,locals){var keys=Object.keys(locals);var values=keys.map(function(key){return locals[key]});var code="(function ("+keys.join(", ")+") {"+program+"})";return eval(code).apply(null,values)}exports.wrapExecutionError=function(e){return new PouchPluginError({name:e.name,message:e.toString()+"\n\n"+e.stack,status:500})}},{extend:1,"pouchdb-plugin-error":17}],13:[function(require,module,exports){(function(global){"use strict";var extend=require("extend");var isEmpty=require("is-empty");var querystring=require("querystring");var Promise=require("pouchdb-promise");var uuid=require("random-uuid-v4");var buildUserContextObject=require("./couchusercontextobject.js");var normalizeHeaderCase=require("header-case-normalizer");module.exports=function buildRequestObject(db,pathEnd,options){var infoPromise=db.info();var pathPromise=infoPromise.then(function(info){pathEnd.unshift(encodeURIComponent(info.db_name));return normalizePath(pathEnd)});var userCtxPromise=infoPromise.then(buildUserContextObject);return Promise.all([pathPromise,infoPromise,userCtxPromise]).then(function(args){args.push(getHost(db));args.push(uuid());args.push(options);return actuallyBuildRequestObject.apply(null,args)})};function getHost(db){try{var url=decodeURI(db.getUrl());return url.split("://")[1].split("/")[0].split("@").pop()}catch(err){return"localhost:5984"}}function normalizePath(path){var up=0;for(var i=path.length-1;i>=0;i--){var last=path[i];if(last==="."){path.splice(i,1)}else if(last===".."){path.splice(i,1);up++}else if(up){path.splice(i,1);up--}}for(;up--;up){path.unshift("..")}return path}function actuallyBuildRequestObject(path,info,userCtx,host,uuid,options){var result={body:"undefined",cookie:{},form:{},headers:{Host:host,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":buildAcceptLanguage(),"User-Agent":buildUserAgent()},info:info,method:"GET",path:path.slice(0),peer:"127.0.0.1",query:{},requested_path:path.slice(0),raw_path:"/"+path.join("/"),secObj:{},userCtx:userCtx,uuid:uuid};if(["_show","_update"].indexOf(path[3])===-1){result.id=null}else{result.id=path[5]||null;if(result.id==="_design"&&path[6]){result.id+="/"+path[6]}}if(options&&options.headers){Object.keys(options.headers).forEach(function(header){if(["x-couchdb-requested-path"].indexOf(header)===-1){result.headers[normalizeHeaderCase(header)]=options.headers[header]}else{result.headers[header]=options.headers[header]}});delete options.headers}extend(true,result,options);if(options.path){result.path=options.path}if(options.requested_path){result.requested_path=options.requested_path}var i=result.requested_path.length-1;var pathEnd=result.requested_path[i];if(!isEmpty(result.query)&&pathEnd.indexOf("?")===-1){result.requested_path[i]=pathEnd+"?"+querystring.stringify(result.query)}if(!isEmpty(result.query)&&result.raw_path.indexOf("?")===-1){result.raw_path+="?"+querystring.stringify(result.query)}if(!isEmpty(result.form)&&result.body==="undefined"){result.body=querystring.stringify(result.form);result.headers["Content-Type"]="application/x-www-form-urlencoded";result.headers["Content-Length"]=result.body.length.toString()}if(result.body!=="undefined"&&["POST","PUT","PATCH"].indexOf(result.method)===-1){result.method="POST"}return result}function buildAcceptLanguage(){var lang=(global.navigator||{}).language||(global.navigator||{}).userLanguage;lang=(lang||"en").toLowerCase();if(["en","en-us"].indexOf(lang)!==-1){return"en-us,en;q=0.5"}else{return lang+",en-us;q=0.7,en;q=0.3"}}function buildUserAgent(){var ua=(global.navigator||{}).userAgent;return ua||"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:28.0) Gecko/20100101 Firefox/28.0"}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./couchusercontextobject.js":14,extend:1,"header-case-normalizer":2,"is-empty":3,"pouchdb-promise":4,querystring:10,"random-uuid-v4":11}],14:[function(require,module,exports){"use strict";module.exports=function buildUserContextObject(info){return{db:info.db_name,name:null,roles:["_admin"]}}},{}],15:[function(require,module,exports){"use strict";exports.buildUserContextObject=require("./couchusercontextobject.js");exports.buildRequestObject=require("./couchrequestobject.js")},{"./couchrequestobject.js":13,"./couchusercontextobject.js":14}],16:[function(require,module,exports){"use strict";var Promise=require("pouchdb-promise");module.exports=function createBulkDocsWrapper(handler){return bulkDocsWrapper.bind(null,handler)};function bulkDocsWrapper(handler,bulkDocs,args){var notYetDone=[];var done=[];var promises=args.docs.map(function(doc){return handler(doc,args).then(function(){notYetDone.push(doc)}).catch(function(err){err.id=doc._id;done.push(err)})});return Promise.all(promises).then(function(){args.docs=notYetDone;return bulkDocs()}).then(function(dbResponses){return done.concat(dbResponses)})}},{"pouchdb-promise":4}],17:[function(require,module,exports){"use strict";function PouchPluginError(opts){this.status=opts.status;this.name=opts.name;this.message=opts.message;this.error=true;this.stack=(new Error).stack}PouchPluginError.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message})};module.exports=PouchPluginError},{}],18:[function(require,module,exports){"use strict";var coucheval=require("couchdb-eval");var couchdb_objects=require("couchdb-objects");var wrappers=require("pouchdb-wrappers");var createBulkDocsWrapper=require("pouchdb-bulkdocs-wrapper");var PouchPluginError=require("pouchdb-plugin-error");var uuid=require("random-uuid-v4");var Promise=require("pouchdb-promise");function oldDoc(db,id){return db.get(id,{revs:true}).catch(function(){return null})}function validate(validationFuncs,newDoc,oldDoc,options){newDoc._revisions=(oldDoc||{})._revisions;try{validationFuncs.forEach(function(validationFuncInfo){var func=validationFuncInfo.func;var designDoc=validationFuncInfo.designDoc;func.call(designDoc,newDoc,oldDoc,options.userCtx,options.secObj)})}catch(e){if(typeof e.unauthorized!=="undefined"){throw new PouchPluginError({name:"unauthorized",message:e.unauthorized,status:401})}else if(typeof e.forbidden!=="undefined"){throw new PouchPluginError({name:"forbidden",message:e.forbidden,status:403})}else{throw coucheval.wrapExecutionError(e)}}}function doValidation(db,newDoc,options){var isHttp=["http","https"].indexOf(db.type())!==-1;if(isHttp&&!options.checkHttp){return Promise.resolve()}if(String(newDoc._id).indexOf("_design/")===0||String(newDoc._id).indexOf("_local")===0){return Promise.resolve()}return getValidationFunctions(db).then(function(validationFuncs){if(!validationFuncs.length){return}var completeOptionsPromise=completeValidationOptions(db,options);var oldDocPromise=oldDoc(db,newDoc._id);return Promise.all([completeOptionsPromise,oldDocPromise]).then(Function.prototype.apply.bind(function(completeOptions,oldDoc){return validate(validationFuncs,newDoc,oldDoc,completeOptions)},null))})}function completeValidationOptions(db,options){if(!options.secObj){options.secObj={}}var userCtxPromise;if(options.userCtx){userCtxPromise=Promise.resolve(options.userCtx)}else{var buildUserContext=couchdb_objects.buildUserContextObject;userCtxPromise=db.info().then(buildUserContext)}return userCtxPromise.then(function(userCtx){options.userCtx=userCtx;return options})}function getValidationFunctions(db){return db.allDocs({startkey:"_design/",endkey:"_design0",include_docs:true}).then(parseValidationFunctions)}function parseValidationFunctions(resp){var validationFuncs=resp.rows.map(function(row){return{designDoc:row.doc,code:row.doc.validate_doc_update}});validationFuncs=validationFuncs.filter(function(info){return typeof info.code!=="undefined"});validationFuncs.forEach(function(info){info.func=coucheval.evaluate(info.designDoc,{},info.code)});return validationFuncs}var wrapperApi={};wrapperApi.put=function(orig,args){return doValidation(args.base,args.doc,args.options).then(orig)};wrapperApi.post=function(orig,args){args.doc._id=args.doc._id||uuid();return doValidation(args.base,args.doc,args.options).then(orig)};wrapperApi.remove=function(orig,args){args.doc._deleted=true;return doValidation(args.base,args.doc,args.options).then(orig)};wrapperApi.bulkDocs=createBulkDocsWrapper(function(doc,args){doc._id=doc._id||uuid();return doValidation(args.base,doc,args.options)});wrapperApi.putAttachment=function(orig,args){return args.base.get(args.docId,{rev:args.rev,revs:true}).catch(function(){return{_id:args.docId}}).then(function(doc){doc._attachments=doc._attachments||{};doc._attachments[args.attachmentId]={content_type:args.type,data:args.doc};return doValidation(args.base,doc,args.options)}).then(orig)};wrapperApi.removeAttachment=function(orig,args){return args.base.get(args.docId,{rev:args.rev,revs:true}).then(function(doc){delete doc._attachments[args.attachmentId];return doValidation(args.base,doc,args.options)}).then(orig)};Object.keys(wrapperApi).forEach(function(name){var exportName="validating"+name[0].toUpperCase()+name.substr(1);var orig=function(){return this[name].apply(this,arguments)};exports[exportName]=wrappers.createWrapperMethod(name,orig,wrapperApi[name])});exports.installValidationMethods=function(){var db=this;try{wrappers.installWrapperMethods(db,wrapperApi)}catch(err){throw new PouchPluginError({status:500,name:"already_installed",message:"Validation methods are already installed on this database."})}};exports.uninstallValidationMethods=function(){var db=this;try{wrappers.uninstallWrapperMethods(db,wrapperApi)}catch(err){throw new PouchPluginError({status:500,name:"already_not_installed",message:"Validation methods are already not installed on this database."})}}},{"couchdb-eval":12,"couchdb-objects":15,"pouchdb-bulkdocs-wrapper":16,"pouchdb-plugin-error":17,"pouchdb-promise":4,"pouchdb-wrappers":19,"random-uuid-v4":11}],19:[function(require,module,exports){"use strict";var nodify=require("promise-nodify");exports.installStaticWrapperMethods=function(PouchDB,handlers){PouchDB.new=PouchDB.new||function(name,options,callback){return new PouchDB(name,options,callback)};PouchDB.destroy=PouchDB.destroy||function(name,options,callback){var args=parseBaseArgs(PouchDB,this,options,callback);var db=new PouchDB(name,args.options);var promise=db.destroy();nodify(promise,args.callback);return promise};installWrappers(PouchDB,handlers,exports.createStaticWrapperMethod)};exports.installWrapperMethods=function(db,handlers){installWrappers(db,handlers,exports.createWrapperMethod)};function installWrappers(base,handlers,createWrapperMethod){for(var name in handlers){if(!handlers.hasOwnProperty(name)){continue}var info=getBaseAndName(base,name);var original=info.base[info.name];if(!original){continue}if(original.hasOwnProperty("_handlers")){if(original._handlers.indexOf(handlers[name])!==-1){throw new Error("Wrapper method for '"+name+"' already installed: "+handlers[name])}original._handlers.push(handlers[name])}else{info.base[info.name]=createWrapperMethod(name,original,handlers[name],base)}}}function getBaseAndName(base,name){name=name.split(".");while(name.length>1){base=base[name.shift(0)]}return{base:base,name:name[0]}}exports.createStaticWrapperMethod=function(name,original,handler,PouchDB){return createWrapper(name,original,handler,staticWrapperBuilders,PouchDB)};exports.createWrapperMethod=function(name,original,handler,db){return createWrapper(name,original,handler,wrapperBuilders,db)};function createWrapper(name,original,handler,theWrapperBuilders,thisVal){var buildWrapper=theWrapperBuilders[name];if(typeof buildWrapper==="undefined"){throw new Error("No known wrapper for method name: "+name)}var handlers=[handler];var wrapper=buildWrapper(thisVal,original,handlers);wrapper._original=original;wrapper._handlers=handlers;return wrapper}var wrapperBuilders={};wrapperBuilders.destroy=function(db,destroy,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCall(destroy))}};wrapperBuilders.put=function(db,put,handlers){return function(){var args={};args.base=db||this;var argsList=Array.prototype.slice.call(arguments);args.doc=argsList.shift();var id="_id"in args.doc;do{var temp=argsList.shift();var temptype=typeof temp;if(temptype==="string"&&!id){args.doc._id=temp;id=true}else if(temptype==="string"&&id&&!("_rev"in args.doc)){args.doc._rev=temp}else if(temptype==="object"){args.options=temp}else if(temptype==="function"){args.callback=temp}}while(argsList.length);args.options=args.options||{};return callHandlers(handlers,args,function(){return put.call(this,args.doc,args.options)})}};wrapperBuilders.post=function(db,post,handlers){return function(doc,options,callback){var args=parseBaseArgs(db,this,options,callback);args.doc=doc;return callHandlers(handlers,args,function(){return post.call(this,args.doc,args.options)})}};wrapperBuilders.get=function(db,get,handlers){return function(docId,options,callback){var args=parseBaseArgs(db,this,options,callback);args.docId=docId;return callHandlers(handlers,args,function(){return get.call(this,args.docId,args.options)})}};wrapperBuilders.remove=function(db,remove,handlers){return function(docOrId,optsOrRev,opts,callback){var args;if(typeof optsOrRev==="string"){args=parseBaseArgs(db,this,opts,callback);args.doc={_id:docOrId,_rev:optsOrRev}}else{args=parseBaseArgs(db,this,optsOrRev,opts);args.doc=docOrId}return callHandlers(handlers,args,function(){return remove.call(this,args.doc,args.options)})}};wrapperBuilders.bulkDocs=function(db,bulkDocs,handlers){return function(docs,options,callback){var args=parseBaseArgs(db,this,options,callback);if(typeof docs==="object"&&"new_edits"in docs){args.options.new_edits=docs.new_edits}args.docs=docs.docs||docs;return callHandlers(handlers,args,function(){return bulkDocs.call(this,args.docs,args.options)})}};wrapperBuilders.allDocs=function(db,allDocs,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCallWithOptions(allDocs,args))}};wrapperBuilders.bulkGet=wrapperBuilders.allDocs;wrapperBuilders.changes=function(db,changes,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCallWithOptions(changes,args))}};wrapperBuilders.sync=function(db,replicate,handlers){return function(url,options,callback){var args=parseBaseArgs(db,this,options,callback);args.url=url;return callHandlers(handlers,args,function(){return replicate.call(this,args.url,args.options)})}};wrapperBuilders["replicate.from"]=wrapperBuilders.sync;wrapperBuilders["replicate.to"]=wrapperBuilders.sync;wrapperBuilders.putAttachment=function(db,putAttachment,handlers){return function(docId,attachmentId,rev,doc,type,options,callback){var args;if(typeof type==="string"){args=parseBaseArgs(db,this,options,callback);args.rev=rev;args.doc=doc;args.type=type}else{args=parseBaseArgs(db,this,type,options);args.rev=null;args.doc=rev;args.type=doc}args.docId=docId;args.attachmentId=attachmentId;return callHandlers(handlers,args,function(){return putAttachment.call(this,args.docId,args.attachmentId,args.rev,args.doc,args.type)})}};wrapperBuilders.getAttachment=function(db,getAttachment,handlers){return function(docId,attachmentId,options,callback){var args=parseBaseArgs(db,this,options,callback);args.docId=docId;args.attachmentId=attachmentId;return callHandlers(handlers,args,function(){return getAttachment.call(this,args.docId,args.attachmentId,args.options)})}};wrapperBuilders.removeAttachment=function(db,removeAttachment,handlers){return function(docId,attachmentId,rev,options,callback){var args=parseBaseArgs(db,this,options,callback);args.docId=docId;args.attachmentId=attachmentId;args.rev=rev;return callHandlers(handlers,args,function(){return removeAttachment.call(this,args.docId,args.attachmentId,args.rev)})}};wrapperBuilders.query=function(db,query,handlers){return function(fun,options,callback){var args=parseBaseArgs(db,this,options,callback);args.fun=fun;return callHandlers(handlers,args,function(){return query.call(this,args.fun,args.options)})}};wrapperBuilders.viewCleanup=function(db,viewCleanup,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCallWithOptions(viewCleanup,args))}};wrapperBuilders.createIndex=function(db,createIndex,handlers){return function(index,options,callback){var args=parseBaseArgs(db,this,options,callback);args.index=index;return callHandlers(handlers,args,function(){return createIndex.call(this,args.index)})}};wrapperBuilders.deleteIndex=wrapperBuilders.createIndex;wrapperBuilders.find=function(db,find,handlers){return function(request,options,callback){var args=parseBaseArgs(db,this,options,callback);args.request=request;return callHandlers(handlers,args,function(){return find.call(this,args.request)})}};wrapperBuilders.explain=wrapperBuilders.find;wrapperBuilders.info=function(db,info,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCall(info))}};wrapperBuilders.getIndexes=wrapperBuilders.info;wrapperBuilders.compact=function(db,compact,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCallWithOptions(compact,args))}};wrapperBuilders.revsDiff=function(db,revsDiff,handlers){return function(diff,options,callback){var args=parseBaseArgs(db,this,options,callback);args.diff=diff;return callHandlers(handlers,args,function(){return revsDiff.call(this,args.diff)})}};wrapperBuilders.list=function(db,orig,handlers){return function(path,options,callback){var args=parseBaseArgs(db,this,options,callback);args.path=path;return callHandlers(handlers,args,function(){return orig.call(this,args.path,args.options)})}};wrapperBuilders.rewriteResultRequestObject=wrapperBuilders.list;wrapperBuilders.show=wrapperBuilders.list;wrapperBuilders.update=wrapperBuilders.list;wrapperBuilders.getSecurity=function(db,getSecurity,handlers){return function(options,callback){var args=parseBaseArgs(db,this,options,callback);return callHandlers(handlers,args,makeCallWithOptions(getSecurity,args))}};wrapperBuilders.putSecurity=function(db,putSecurity,handlers){return function(secObj,options,callback){var args=parseBaseArgs(db,this,options,callback);args.secObj=secObj;return callHandlers(handlers,args,function(){return putSecurity.call(this,args.secObj)})}};var staticWrapperBuilders={};staticWrapperBuilders.new=function(PouchDB,construct,handlers){return function(name,options,callback){var args;if(typeof name==="object"){args=parseBaseArgs(PouchDB,this,name,options)}else{args=parseBaseArgs(PouchDB,this,options,callback);args.options.name=name}return callHandlers(handlers,args,function(){return construct.call(this,args.options)})}};staticWrapperBuilders.destroy=function(PouchDB,destroy,handlers){return function(name,options,callback){var args;if(typeof name==="object"){args=parseBaseArgs(PouchDB,this,name,options)}else{args=parseBaseArgs(PouchDB,this,options,callback);args.options.name=name}if(args.options.internal){return destroy.apply(PouchDB,arguments)}return callHandlers(handlers,args,function(){var name=args.options.name;delete args.options.name;return destroy.call(this,name,args.options)})}};staticWrapperBuilders.replicate=function(PouchDB,replicate,handlers){return function(source,target,options,callback){var args=parseBaseArgs(PouchDB,this,options,callback);args.source=source;args.target=target;return callHandlers(handlers,args,function(){return replicate.call(this,args.source,args.target,args.options)})}};staticWrapperBuilders.allDbs=function(PouchDB,allDbs,handlers){return function(options,callback){var args=parseBaseArgs(PouchDB,this,options,callback);return callHandlers(handlers,args,makeCall(allDbs))}};function parseBaseArgs(thisVal1,thisVal2,options,callback){if(typeof options==="function"){callback=options;options={}}return{base:thisVal1||thisVal2,options:options||{},callback:callback}}function callHandlers(handlers,args,method){var callback=args.callback;delete args.callback;method=method.bind(args.base);for(var i=handlers.length-1;i>=0;i-=1){method=handlers[i].bind(null,method,args)}var promise=method();nodify(promise,callback);return promise}function makeCall(func){return function(){return func.call(this)}}function makeCallWithOptions(func,args){return function(){return func.call(this,args.options)}}exports.uninstallWrapperMethods=function(db,handlers){uninstallWrappers(db,handlers)};exports.uninstallStaticWrapperMethods=function(PouchDB,handlers){uninstallWrappers(PouchDB,handlers)};function uninstallWrappers(base,handlers){for(var name in handlers){if(!handlers.hasOwnProperty(name)){continue}var info=getBaseAndName(base,name);var wrapper=info.base[info.name];if(typeof wrapper==="undefined"){continue}var idx;try{idx=wrapper._handlers.indexOf(handlers[name])}catch(err){idx=-1}if(idx===-1){throw new Error("Wrapper method for '"+name+"' not installed: "+handlers[name])}wrapper._handlers.splice(idx,1);if(!wrapper._handlers.length){delete info.base[info.name];if(info.base[info.name]!==wrapper._original){info.base[info.name]=wrapper._original}}}}},{"promise-nodify":7}]},{},[18])(18)});